<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Creating new crawlers &mdash; comics v1.0a0 documentation</title>
    <link rel="stylesheet" href="static/nature.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0a0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="comics v1.0a0 documentation" href="index.html" />
    <link rel="next" title="Deployment" href="deployment.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="deployment.html" title="Deployment"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">comics v1.0a0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="creating-new-crawlers">
<h1>Creating new crawlers<a class="headerlink" href="#creating-new-crawlers" title="Permalink to this headline">¶</a></h1>
<p>For each comic <em>comics</em> is aggregating, we need to create a crawler. At the
time of writing, about 100 crawlers are available in the
<tt class="docutils literal"><span class="pre">comics/comics/comics/</span></tt> directory. They serve as a great source for learning
how to write new crawlers for <em>comics</em>.</p>
<div class="section" id="a-crawler-example">
<h2>A crawler example<a class="headerlink" href="#a-crawler-example" title="Permalink to this headline">¶</a></h2>
<p>The crawlers are split in two separate pieces. The <tt class="docutils literal"><span class="pre">Meta</span></tt> part contains meta
data about the comic used for display at the web site. The <tt class="docutils literal"><span class="pre">Crawler</span></tt> part
contains properties needed for crawling and the crawler implementation itself.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">comics.aggregator.crawler</span> <span class="kn">import</span> <span class="n">CrawlerBase</span><span class="p">,</span> <span class="n">CrawlerImage</span>
<span class="kn">from</span> <span class="nn">comics.meta.base</span> <span class="kn">import</span> <span class="n">MetaBase</span>

<span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">MetaBase</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;xkcd&#39;</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s">&#39;en&#39;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.xkcd.com/&#39;</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="s">&#39;2005-05-29&#39;</span>
    <span class="n">rights</span> <span class="o">=</span> <span class="s">&#39;Randall Munroe, CC BY-NC 2.5&#39;</span>

<span class="k">class</span> <span class="nc">Crawler</span><span class="p">(</span><span class="n">CrawlerBase</span><span class="p">):</span>
    <span class="n">history_capable_days</span> <span class="o">=</span> <span class="mf">10</span>
    <span class="n">schedule</span> <span class="o">=</span> <span class="s">&#39;Mo,We,Fr&#39;</span>
    <span class="n">time_zone</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5</span>

    <span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pub_date</span><span class="p">):</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_feed</span><span class="p">(</span><span class="s">&#39;http://www.xkcd.com/rss.xml&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">for_date</span><span class="p">(</span><span class="n">pub_date</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="s">&#39;img[src*=&quot;/comics/&quot;]&#39;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">title</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">alt</span><span class="p">(</span><span class="s">&#39;img[src*=&quot;/comics/&quot;]&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-meta-class-fields">
<h2>The <tt class="docutils literal"><span class="pre">Meta</span></tt> class fields<a class="headerlink" href="#the-meta-class-fields" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">Meta.name</span></tt></dt>
<dd><em>Required.</em> A string with the name of the comic.</dd>
<dt><tt class="docutils literal"><span class="pre">Meta.language</span></tt></dt>
<dd><p class="first"><em>Required.</em> A two-letter string with the language code for the language
used in the comic. Typically <tt class="docutils literal"><span class="pre">'en'</span></tt> or <tt class="docutils literal"><span class="pre">'no'</span></tt>.</p>
<p class="last">Code must also be present in <tt class="docutils literal"><span class="pre">comics.core.models.Comic.LANGUAGES</span></tt>.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Meta.url</span></tt></dt>
<dd><em>Required.</em> A string with the URL of the comic&#8217;s web page.</dd>
<dt><tt class="docutils literal"><span class="pre">Meta.start_date</span></tt></dt>
<dd><em>Optional.</em> The first date the comic was published at.</dd>
<dt><tt class="docutils literal"><span class="pre">Meta.end_date</span></tt></dt>
<dd><em>Optional.</em> The last date the comic was published at if it is discontinued.</dd>
<dt><tt class="docutils literal"><span class="pre">Meta.rights</span></tt></dt>
<dd><em>Optional.</em> Name of the author and the comic&#8217;s license if available.</dd>
</dl>
</div>
<div class="section" id="the-crawler-class-fields">
<h2>The <tt class="docutils literal"><span class="pre">Crawler</span></tt> class fields<a class="headerlink" href="#the-crawler-class-fields" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fields-used-for-crawling">
<h3>Fields used for crawling<a class="headerlink" href="#fields-used-for-crawling" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">Crawler.history_capable_date</span></tt></dt>
<dd><p class="first"><em>Optional.</em> Date of oldest release available for crawling. Provide this
<em>or</em> <tt class="docutils literal"><span class="pre">Crawler.history_capable_days</span></tt>. If both are present, this one will
have precedence.</p>
<p class="last">Example: <tt class="docutils literal"><span class="pre">'2008-03-08'</span></tt>.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Crawler.history_capable_days</span></tt></dt>
<dd><p class="first"><em>Optional.</em> Number of days a release is available for crawling. Provide
this <em>or</em> <tt class="docutils literal"><span class="pre">Crawler.history_capable_date</span></tt>.</p>
<p class="last">Example: <tt class="docutils literal"><span class="pre">32</span></tt>.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Crawler.schedule</span></tt></dt>
<dd><p class="first"><em>Optional.</em> On what weekdays the comic is published.</p>
<p class="last">Example: <tt class="docutils literal"><span class="pre">'Mo,We,Fr'</span></tt> or <tt class="docutils literal"><span class="pre">'Mo,Tu,We,Th,Fr,Sa,Su'</span></tt>.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Crawler.time_zone</span></tt></dt>
<dd><p class="first"><em>Optional.</em> In approximately what time zone (in whole hours relative to
UTC, without regard to DST) the comic is published.</p>
<p class="last">Example: <tt class="docutils literal"><span class="pre">1</span></tt> for central Europe or <tt class="docutils literal"><span class="pre">-5</span></tt> for eastern U.S.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Crawler.multiple_releases_per_day</span></tt></dt>
<dd><p class="first"><em>Optional.</em> Default: <tt class="xref docutils literal"><span class="pre">False</span></tt>. Whether to allow multiple releases per day.</p>
<p class="last">Example: <tt class="xref docutils literal"><span class="pre">True</span></tt> or <tt class="xref docutils literal"><span class="pre">False</span></tt>.</p>
</dd>
</dl>
</div>
<div class="section" id="fields-used-for-downloading">
<h3>Fields used for downloading<a class="headerlink" href="#fields-used-for-downloading" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">Crawler.has_rerun_releases</span></tt></dt>
<dd><p class="first"><em>Optional.</em> Default: <tt class="xref docutils literal"><span class="pre">False</span></tt>. Whether the comic reruns old images as new
releases.</p>
<p class="last">Example: <tt class="xref docutils literal"><span class="pre">True</span></tt> or <tt class="xref docutils literal"><span class="pre">False</span></tt>.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Crawler.check_image_mime_type</span></tt></dt>
<dd><p class="first"><em>Optional.</em> Default: <tt class="xref docutils literal"><span class="pre">True</span></tt>. Whether to check the mime type of the image
when downloading.</p>
<p class="last">Example: <tt class="xref docutils literal"><span class="pre">True</span></tt> or <tt class="xref docutils literal"><span class="pre">False</span></tt>.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="the-crawler-crawl-method">
<h2>The <tt class="docutils literal"><span class="pre">Crawler.crawl()</span></tt> method<a class="headerlink" href="#the-crawler-crawl-method" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">crawl()</span></tt> is where the real work is going on. To start with an example,
let&#8217;s look at <em>XKCD</em>&#8216;s <tt class="docutils literal"><span class="pre">crawl()</span></tt> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pub_date</span><span class="p">):</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_feed</span><span class="p">(</span><span class="s">&#39;http://www.xkcd.com/rss.xml&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">for_date</span><span class="p">(</span><span class="n">pub_date</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="s">&#39;img[src*=&quot;/comics/&quot;]&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">title</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">alt</span><span class="p">(</span><span class="s">&#39;img[src*=&quot;/comics/&quot;]&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="arguments-and-return-values">
<h3>Arguments and return values<a class="headerlink" href="#arguments-and-return-values" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">crawl()</span></tt> method takes a single argument, <tt class="docutils literal"><span class="pre">pub_date</span></tt>, which is a
<tt class="docutils literal"><span class="pre">datetime.date</span></tt> object for the date the crawler is currently crawling. The
goal of the method is to return a <tt class="docutils literal"><span class="pre">CrawlerImage</span></tt> object containing at least
the URL of the image for <tt class="docutils literal"><span class="pre">pub_date</span></tt> and optionally a <tt class="docutils literal"><span class="pre">title</span></tt> and <tt class="docutils literal"><span class="pre">text</span></tt>
accompanying the image. <tt class="docutils literal"><span class="pre">CrawlerImage</span></tt>&#8216;s signature is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>This means that you must always supply an URL, and that you can supply a
<tt class="docutils literal"><span class="pre">text</span></tt> without a <tt class="docutils literal"><span class="pre">title</span></tt>. The following are all valid ways to create a
<tt class="docutils literal"><span class="pre">CrawlerImage</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
<span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
<span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
<span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
<p>For some crawlers, this is all you need. If the image URL is predictable and
based upon the <tt class="docutils literal"><span class="pre">pub_date</span></tt> in some way, just create the URL with the help
of <a class="reference external" href="http://docs.python.org/library/datetime.html#strftime-behavior">Python&#8217;s strftime documentation</a>, and return
it wrapped in a <tt class="docutils literal"><span class="pre">CrawlerImage</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pub_date</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.example.com/comics/</span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">pub_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">),)</span>
    <span class="k">return</span> <span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
<p>Though, for most crawlers, some interaction with RSS or Atom feeds or web pages
are needed. For this a web parser and a feed parser are provided.</p>
</div>
<div class="section" id="returning-multiple-images-for-a-single-comic-release">
<h3>Returning multiple images for a single comic release<a class="headerlink" href="#returning-multiple-images-for-a-single-comic-release" title="Permalink to this headline">¶</a></h3>
<p>Some comics got releases with multiple images, and thus returning a single
<tt class="docutils literal"><span class="pre">CrawlerImage</span></tt> will not be enough for you. For situations like these,
<em>comics</em> lets you return a list of <tt class="docutils literal"><span class="pre">CrawlerImage</span></tt> objects from <tt class="docutils literal"><span class="pre">crawl()</span></tt>.
The list should be ordered in the same way as the comic is meant to be read,
with the first frame as the first element in the list. If the comic release got
a <tt class="docutils literal"><span class="pre">title</span></tt>, add it to the first <tt class="docutils literal"><span class="pre">CrawlerImage</span></tt> object, and let the <tt class="docutils literal"><span class="pre">title</span></tt>
field stay empty on the rest of the list elements. The same applies for the
<tt class="docutils literal"><span class="pre">text</span></tt> field, unless each image actually got a different <tt class="docutils literal"><span class="pre">title</span></tt> or
<tt class="docutils literal"><span class="pre">text</span></tt> string.</p>
<p>The following is an example of a <tt class="docutils literal"><span class="pre">crawl()</span></tt> method which returns multiple
images. It adds a <tt class="docutils literal"><span class="pre">title</span></tt> to the first list element, and different <tt class="docutils literal"><span class="pre">text</span></tt>
to all of the elements.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pub_date</span><span class="p">):</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_feed</span><span class="p">(</span><span class="s">&#39;http://feeds.feedburner.com/Pidjin&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">for_date</span><span class="p">(</span><span class="n">pub_date</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="mf">10</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">content0</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="s">&#39;img[src$=&quot;000</span><span class="si">%d</span><span class="s">.jpg&quot;]&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">content0</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;img[src$=&quot;000</span><span class="si">%d</span><span class="s">.jpg&quot;]&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-web-parser">
<h2>The web parser<a class="headerlink" href="#the-web-parser" title="Permalink to this headline">¶</a></h2>
<p>The web parser, internally known as <tt class="docutils literal"><span class="pre">LxmlParser</span></tt>, uses CSS selectors to
extract content from HTML:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pub_date</span><span class="p">):</span>
    <span class="n">page_url</span> <span class="o">=</span> <span class="s">&#39;http://ars.userfriendly.org/cartoons/?id=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">pub_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">),)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_page</span><span class="p">(</span><span class="n">page_url</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="s">&#39;img[alt^=&quot;Strip for&quot;]&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a common pattern for crawlers. Another common patterns is to use a feed
to find the web page URL for the given date, then parse that web page to find
the image URL.</p>
<p>For a primer on CSS selectors, see <a class="reference internal" href="#css-selectors"><em>Matching HTML elements using CSS selectors</em></a>.</p>
<div class="section" id="available-methods">
<h3>Available methods<a class="headerlink" href="#available-methods" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">text(selector,</span> <span class="pre">default=None)</span></tt></dt>
<dd>Returns the text contained by the element matching <tt class="docutils literal"><span class="pre">selector</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">src(selector,</span> <span class="pre">default=None)</span></tt></dt>
<dd><p class="first">Returns the <tt class="docutils literal"><span class="pre">src</span></tt> attribute of the element matching <tt class="docutils literal"><span class="pre">selector</span></tt>.</p>
<p class="last">The web parser automatically expands relative URLs in the source, like
<tt class="docutils literal"><span class="pre">/comics/2008-04-13.png</span></tt> to a full URL like
<tt class="docutils literal"><span class="pre">http://www.example.com/2008-04-13.png</span></tt>, so you do not need to think
about that.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">alt(selector,</span> <span class="pre">default=None)</span></tt></dt>
<dd>Returns the <tt class="docutils literal"><span class="pre">alt</span></tt> attribute of the element matching <tt class="docutils literal"><span class="pre">selector</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">title(selector,</span> <span class="pre">default=None)</span></tt></dt>
<dd>Returns the <tt class="docutils literal"><span class="pre">title</span></tt> attribute of the element matching <tt class="docutils literal"><span class="pre">selector</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">href(selector,</span> <span class="pre">default=None)</span></tt></dt>
<dd>Returns the <tt class="docutils literal"><span class="pre">href</span></tt> attribute of the element matching <tt class="docutils literal"><span class="pre">selector</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">remove(selector)</span></tt></dt>
<dd>Remove the elements matching <tt class="docutils literal"><span class="pre">selector</span></tt> from the parsed document.</dd>
</dl>
</div>
</div>
<div class="section" id="the-feed-parser">
<h2>The feed parser<a class="headerlink" href="#the-feed-parser" title="Permalink to this headline">¶</a></h2>
<p>The feed parser is initialized with a feed URL, just like the web parser is
initialized with a web page URL:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_feed</span><span class="p">(</span><span class="s">&#39;http://www.xkcd.com/rss.xml&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="feed-methods">
<h3>Feed methods<a class="headerlink" href="#feed-methods" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">feed</span></tt> object provides two methods which both returns feed elements:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">for_date(date)</span></tt></dt>
<dd>Returns all feed elements published at <tt class="docutils literal"><span class="pre">date</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">all()</span></tt></dt>
<dd>Returns all feed elements.</dd>
</dl>
<p>Typically, a crawler uses <tt class="docutils literal"><span class="pre">for_date(date)</span></tt> and loops over all entries it
returns to find the image URL:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">for_date</span><span class="p">(</span><span class="n">pub_date</span><span class="p">):</span>
    <span class="c"># parsing comes here</span>
    <span class="k">return</span> <span class="n">CrawlerImage</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="entry-fields-with-lxmlparser">
<h3>Entry fields with <tt class="docutils literal"><span class="pre">LxmlParser</span></tt><a class="headerlink" href="#entry-fields-with-lxmlparser" title="Permalink to this headline">¶</a></h3>
<p>The <em>comics</em> feed parser is really a combination of <a class="reference external" href="http://www.feedparser.org/">feedparser</a> and <tt class="docutils literal"><span class="pre">LxmlParser</span></tt>. It can do anything
<em>feedparser</em> can do, and in addition you can use the <tt class="docutils literal"><span class="pre">LxmlParser</span></tt> methods on
feed fields which contains HTML:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">summary</span></tt></dt>
<dd>This is the most frequently used entry field which supports HTML parsing
with the <tt class="docutils literal"><span class="pre">LxmlParser</span></tt> methods.</dd>
<dt><tt class="docutils literal"><span class="pre">content0</span></tt></dt>
<dd>This is the same as <em>feedparser</em>&#8216;s <tt class="docutils literal"><span class="pre">content[0].value</span></tt> field, but with
<tt class="docutils literal"><span class="pre">LxmlParser</span></tt> methods available. For some crawlers, this is where the
interesting stuff is found.</dd>
</dl>
<div class="highlight-python"><div class="highlight"><pre><span class="n">url</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="s">&#39;img&#39;</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">alt</span><span class="p">(</span><span class="s">&#39;img&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you need to parse HTML in any other fields than the above two, you can apply
the <tt class="docutils literal"><span class="pre">html(string)</span></tt> method on the field, like it is applied on a feed entry&#8217;s
title field here:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">title</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;h1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="matching-html-elements-using-css-selectors">
<span id="css-selectors"></span><h2>Matching HTML elements using CSS selectors<a class="headerlink" href="#matching-html-elements-using-css-selectors" title="Permalink to this headline">¶</a></h2>
<p>Both web page and feed parsing uses CSS selectors to extract the interesting
strings from HTML. CSS selectors are those normally simple strings you use in
CSS style sheets to select what elements of your web page the CSS declarations
should be applied to.</p>
<p>In the following example <tt class="docutils literal"><span class="pre">h1</span> <span class="pre">a</span></tt> is the selector. It matches all <tt class="docutils literal"><span class="pre">a</span></tt>
elements contained in <tt class="docutils literal"><span class="pre">h1</span></tt> elements. The rule to be applied to the matching
elements is <tt class="docutils literal"><span class="pre">color:</span> <span class="pre">red;</span></tt>.</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nt">h1</span> <span class="nt">a</span> <span class="p">{</span> <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Similarly <tt class="docutils literal"><span class="pre">class=&quot;foo&quot;</span></tt> and <tt class="docutils literal"><span class="pre">id=&quot;bar&quot;</span></tt> in HTML may be used in CSS
selectors. The following CSS example would color all <tt class="docutils literal"><span class="pre">h1</span></tt> headers with the
class <tt class="docutils literal"><span class="pre">foo</span></tt> red, and all elements with the ID <tt class="docutils literal"><span class="pre">bar</span></tt> which is contained in
<tt class="docutils literal"><span class="pre">h1</span></tt> elements would be colored blue.</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nt">h1</span><span class="nc">.foo</span> <span class="p">{</span> <span class="k">color</span> <span class="nb">red</span><span class="p">;</span> <span class="p">}</span>
<span class="nt">h1</span> <span class="nf">#bar</span> <span class="p">{</span> <span class="k">color</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>In CSS3, the power of CSS selectors have been greatly increased by the addition
of matching by the content of elements&#8217; arguments. To match all <tt class="docutils literal"><span class="pre">img</span></tt>
elements with a <tt class="docutils literal"><span class="pre">src</span></tt> attribute <em>starting with</em> <tt class="docutils literal"><span class="pre">http://www.example.com/</span></tt>
simply write:</p>
<div class="highlight-python"><pre>img[src^="http://www.example.com/"]</pre>
</div>
<p>Or, to match all <tt class="docutils literal"><span class="pre">img</span></tt> elements whose <tt class="docutils literal"><span class="pre">src</span></tt> attribute <em>ends in</em> <tt class="docutils literal"><span class="pre">.jpg</span></tt>:</p>
<div class="highlight-python"><pre>img[src$=".jpg"]</pre>
</div>
<p>Or, <tt class="docutils literal"><span class="pre">img</span></tt> elements whose <tt class="docutils literal"><span class="pre">src</span></tt> attribute <em>contains</em> <tt class="docutils literal"><span class="pre">/comics/</span></tt>:</p>
<div class="highlight-python"><pre>img[src*="/comics/"]</pre>
</div>
<p>Or, <tt class="docutils literal"><span class="pre">img</span></tt> elements whose <tt class="docutils literal"><span class="pre">alt</span></tt> attribute <em>is</em> <tt class="docutils literal"><span class="pre">Today's</span> <span class="pre">comic</span></tt>:</p>
<div class="highlight-python"><pre>img[alt="Today's comic"]</pre>
</div>
<p>For further details on CSS selectors in general, please refer to
<a class="reference external" href="http://css.maxdesign.com.au/selectutorial/">http://css.maxdesign.com.au/selectutorial/</a>.</p>
</div>
<div class="section" id="testing-your-new-crawler">
<h2>Testing your new crawler<a class="headerlink" href="#testing-your-new-crawler" title="Permalink to this headline">¶</a></h2>
<p>When the first version of you crawler is complete, it&#8217;s time to test it.</p>
<p>The file name is important, as it is used as the comic&#8217;s slug. This means that
it must be unique within the <em>comics</em> installation, and that it is used in the
URLs <em>comics</em> will serve the comic at. For this example, we call the crawler
file <tt class="docutils literal"><span class="pre">foo.py</span></tt>. The file must be placed in the <tt class="docutils literal"><span class="pre">comics/comics/comics/</span></tt>
directory, and will be available in Python as <tt class="docutils literal"><span class="pre">comics.comics.foo</span></tt>.</p>
<div class="section" id="loading-meta-for-your-new-comic">
<h3>Loading <tt class="docutils literal"><span class="pre">Meta</span></tt> for your new comic<a class="headerlink" href="#loading-meta-for-your-new-comic" title="Permalink to this headline">¶</a></h3>
<p>For <em>comics</em> to know about your new crawler, you need to load the comic meta
data into <em>comics</em>&#8216;s database. To do so, we run the <tt class="docutils literal"><span class="pre">loadmeta</span></tt> command:</p>
<div class="highlight-python"><pre>python manage.py loadmeta -c foo</pre>
</div>
<p>If you do any changes to the <tt class="docutils literal"><span class="pre">Meta</span></tt> class of any crawler, you must rerun
<tt class="docutils literal"><span class="pre">loadmeta</span></tt> to update the database representation of the comic.</p>
</div>
<div class="section" id="running-the-crawler">
<h3>Running the crawler<a class="headerlink" href="#running-the-crawler" title="Permalink to this headline">¶</a></h3>
<p>When <tt class="docutils literal"><span class="pre">loadmeta</span></tt> has created a <tt class="docutils literal"><span class="pre">Comic</span></tt> instance for the new crawler, you may
use your new crawler to fetch the comic&#8217;s release for the current date by
running:</p>
<div class="highlight-python"><pre>python manage.py getcomics -c foo</pre>
</div>
<p>If you want to get comics releases for more than the current day, you may
specify a date range to crawl, like:</p>
<div class="highlight-python"><pre>python manage.py getcomics -c foo -f 2009-01-01 -t 2009-03-31</pre>
</div>
<p>The date range will automatically be adjusted to the crawlers <em>history
capability</em>. You may also get comics for a date range without a specific end.
In which case, the current date will be used instead:</p>
<div class="highlight-python"><pre>python manage.py getcomics -c foo -f 2009-01-01</pre>
</div>
<p>If your new crawler is not working properly, you may add <tt class="docutils literal"><span class="pre">-v2</span></tt> to the command
to turn on full debug output:</p>
<div class="highlight-python"><pre>python manage.py getcomics -c foo -v2</pre>
</div>
<p>For a full overview of <tt class="docutils literal"><span class="pre">getcomics</span></tt> options, run:</p>
<div class="highlight-python"><pre>python manage.py getcomics --help</pre>
</div>
</div>
</div>
<div class="section" id="submitting-your-new-crawler-for-inclusion-in-comics">
<h2>Submitting your new crawler for inclusion in <em>comics</em><a class="headerlink" href="#submitting-your-new-crawler-for-inclusion-in-comics" title="Permalink to this headline">¶</a></h2>
<p>When your crawler is working properly, you may submit it for inclusion in
<em>comics</em>. You may either send the crawler to <a class="reference external" href="mailto:comics&#37;&#52;&#48;jodal&#46;no">comics<span>&#64;</span>jodal<span>&#46;</span>no</a>, or, even better, fork <em>comics</em> at <a class="reference external" href="http://github.com/jodal/comics">GitHub</a>, commit your new crawler to your own fork,
and send me a <em>pull request</em> through GitHub.</p>
<p>All contributions must be granted under the same license as <em>comics</em> itself.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">Creating new crawlers</a><ul>
<li><a class="reference external" href="#a-crawler-example">A crawler example</a></li>
<li><a class="reference external" href="#the-meta-class-fields">The <tt class="docutils literal"><span class="pre">Meta</span></tt> class fields</a></li>
<li><a class="reference external" href="#the-crawler-class-fields">The <tt class="docutils literal"><span class="pre">Crawler</span></tt> class fields</a><ul>
<li><a class="reference external" href="#fields-used-for-crawling">Fields used for crawling</a></li>
<li><a class="reference external" href="#fields-used-for-downloading">Fields used for downloading</a></li>
</ul>
</li>
<li><a class="reference external" href="#the-crawler-crawl-method">The <tt class="docutils literal"><span class="pre">Crawler.crawl()</span></tt> method</a><ul>
<li><a class="reference external" href="#arguments-and-return-values">Arguments and return values</a></li>
<li><a class="reference external" href="#returning-multiple-images-for-a-single-comic-release">Returning multiple images for a single comic release</a></li>
</ul>
</li>
<li><a class="reference external" href="#the-web-parser">The web parser</a><ul>
<li><a class="reference external" href="#available-methods">Available methods</a></li>
</ul>
</li>
<li><a class="reference external" href="#the-feed-parser">The feed parser</a><ul>
<li><a class="reference external" href="#feed-methods">Feed methods</a></li>
<li><a class="reference external" href="#entry-fields-with-lxmlparser">Entry fields with <tt class="docutils literal"><span class="pre">LxmlParser</span></tt></a></li>
</ul>
</li>
<li><a class="reference external" href="#matching-html-elements-using-css-selectors">Matching HTML elements using CSS selectors</a></li>
<li><a class="reference external" href="#testing-your-new-crawler">Testing your new crawler</a><ul>
<li><a class="reference external" href="#loading-meta-for-your-new-comic">Loading <tt class="docutils literal"><span class="pre">Meta</span></tt> for your new comic</a></li>
<li><a class="reference external" href="#running-the-crawler">Running the crawler</a></li>
</ul>
</li>
<li><a class="reference external" href="#submitting-your-new-crawler-for-inclusion-in-comics">Submitting your new crawler for inclusion in <em>comics</em></a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="installation.html"
                                  title="previous chapter">Installation</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="deployment.html"
                                  title="next chapter">Deployment</a></p>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="deployment.html" title="Deployment"
             >next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             >previous</a> |</li>
        <li><a href="index.html">comics v1.0a0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, Stein Magnus Jodal.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.2.
    </div>
  </body>
</html>